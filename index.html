<!DOCTYPE html>
<html lang="es">
<head>
  
<!-- Cambiar color Navegaciónn del Browser -->
<!-- color principal de tu sitio -->
  <meta name="theme-color" content="#5e0b15">
<!-- para Windows tiles -->
  <meta name="msapplication-TileColor" content="#5e0b15"> 
<!-- para iOS -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black"> 
<!-- o "black", "black-translucent" -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default"> 
  
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pasaporte del Vino</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
    /* --- VARIABLES Y ESTILOS BASE MODERNOS --- */
    :root {
        /* Paleta de colores moderna */
        --primary: #8B1E3F;
        --primary-dark: #6A1530;
        --primary-light: #A52C4D;
        --secondary: #2C5530;
        --accent: #FFD166;
        --background: #F8F7F4;
        --surface: #FFFFFF;
        --text: #2D2D2D;
        --text-light: #666666;
        --border: #E5E5E5;
        --success: #27AE60;
        --warning: #F39C12;
        --error: #E74C3C;
        --info: #3498DB;
        
        /* Variables del escáner */
        --scanner-accent-green: #2ecc71;
        --scanner-success-color: #27ae60;
        
        /* Sombras modernas */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
        
        /* Bordes redondeados */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 20px;
        --radius-xl: 30px;
        
        /* Transiciones */
        --transition-fast: 0.2s ease;
        --transition-normal: 0.3s ease;
        --transition-slow: 0.5s ease;
    }

    /* --- RESET Y ESTILOS GENERALES --- */
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent;
    }
    
    body { 
        display: flex; 
        flex-direction: column; 
        height: 100vh; 
        overflow: hidden; 
        background-color: var(--background); 
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        font-size: 16px;
        line-height: 1.5;
    }
    
    /* --- HEADER MODERNO --- */
    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 16px 20px; 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white; 
        box-shadow: var(--shadow-md);
        position: fixed; 
        width: 100%; 
        top: 0; 
        z-index: 1000; 
        height: 64px;
        backdrop-filter: blur(10px);
    }
    
    .logo { 
        font-size: 1.4rem; 
        font-weight: 700; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        letter-spacing: -0.5px;
    }
    
    .logo i { 
        font-size: 1.8rem; 
        color: var(--accent);
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    /* --- HAMBURGUER MODERNO ANIMADO --- */
    .hamburger { 
        cursor: pointer; 
        width: 30px;
        height: 30px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.1);
        border-radius: var(--radius-sm);
        transition: var(--transition-normal);
    }
    
    .hamburger:hover {
        background: rgba(255,255,255,0.2);
        transform: scale(1.1);
    }
    
    .hamburger span {
        display: block;
        width: 20px;
        height: 2px;
        background: white;
        border-radius: 2px;
        position: absolute;
        transition: var(--transition-normal);
    }
    
    .hamburger span:nth-child(1) {
        top: 10px;
    }
    
    .hamburger span:nth-child(2) {
        top: 14px;
    }
    
    .hamburger span:nth-child(3) {
        top: 18px;
    }
    
    .hamburger.active span:nth-child(1) {
        transform: rotate(45deg);
        top: 14px;
    }
    
    .hamburger.active span:nth-child(2) {
        opacity: 0;
    }
    
    .hamburger.active span:nth-child(3) {
        transform: rotate(-45deg);
        top: 14px;
    }
    
    /* --- MENÚ LATERAL MODERNO --- */
    #menu { 
        position: fixed; 
        top: 0; 
        right: -320px; 
        width: 320px; 
        height: 100%; 
        background: var(--surface); 
        box-shadow: var(--shadow-lg);
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        z-index: 2000; 
        padding: 80px 24px 24px; 
        overflow-y: auto; 
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    #menu.active { 
        right: 0; 
    }
    
    #menu .close { 
        position: absolute; 
        top: 24px; 
        right: 24px; 
        font-size: 1.8rem; 
        cursor: pointer; 
        color: var(--text-light);
        transition: var(--transition-fast);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    #menu .close:hover {
        background: var(--background);
        color: var(--primary);
    }
    
    #menu ul { 
        list-style: none; 
        flex: 1;
    }
    
    #menu li { 
        margin-bottom: 4px; 
    }
    
    #menu a { 
        text-decoration: none; 
        color: var(--text); 
        font-size: 1.1rem; 
        font-weight: 500;
        display: flex; 
        align-items: center;
        gap: 12px;
        padding: 16px;
        border-radius: var(--radius-md);
        transition: var(--transition-fast);
        position: relative;
        overflow: hidden;
    }
    
    #menu a::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--primary);
        transform: scaleY(0);
        transition: var(--transition-normal);
    }
    
    #menu a:hover { 
        background: var(--background); 
        transform: translateX(4px);
    }
    
    #menu a:hover::before {
        transform: scaleY(1);
    }
    
    #menu a i {
        width: 24px;
        color: var(--primary);
        font-size: 1.2rem;
    }
    
    /* --- OVERLAY --- */
    #overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0, 0, 0, 0.5); 
        backdrop-filter: blur(4px);
        display: none; 
        z-index: 1500; 
        animation: fadeIn 0.3s ease;
    }
    
    #overlay.active { 
        display: block; 
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* --- ÁREA PRINCIPAL CONTENIDO --- */
    main { 
        flex: 1; 
        padding: 80px 20px 70px; 
        overflow-y: auto; 
        background-color: var(--background);
        position: relative;
    }
    
    /* Fondos con marca de agua para cada página (EXCEPTO INICIO) */
    #registrar::before,
    #mipasaporte::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.03"><path d="M100,50 Q150,30 180,80 Q130,100 180,120 Q130,140 100,180 Q70,140 20,120 Q70,100 20,80 Q50,30 100,50Z" fill="%232C5530"/></svg>');
        background-repeat: repeat;
        pointer-events: none;
        z-index: 0;
    }
    
    #establecimientos::before,
    #miestablecimiento::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.03"><path d="M50,50 C70,30 130,30 150,50 C170,70 170,130 150,150 C130,170 70,170 50,150 C30,130 30,70 50,50Z" fill="%23FFD166"/></svg>');
        background-repeat: repeat;
        pointer-events: none;
        z-index: 0;
    }
    
    #admin::before,
    #admin-login::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.03"><rect x="40" y="40" width="120" height="120" rx="15" fill="%233498DB"/></svg>');
        background-repeat: repeat;
        pointer-events: none;
        z-index: 0;
    }
    
    .page { 
        display: none; 
        position: relative;
        z-index: 1;
        animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .page.active { 
        display: block; 
    }
    
    .page h1 { 
        margin-bottom: 24px; 
        color: var(--primary); 
        font-size: 2.2rem; 
        font-weight: 800;
        letter-spacing: -1px;
        position: relative;
        display: inline-block;
    }
    
    .page h1::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border-radius: 2px;
    }
    
    .page h2 { 
        margin: 32px 0 20px; 
        color: var(--secondary); 
        font-size: 1.6rem; 
        font-weight: 700;
        text-align: left;
    }
    
    .page ul, .page ol, .page p { 
        text-align: left; 
        margin: 16px auto; 
        max-width: 800px; 
        line-height: 1.6; 
    }
    
    .page p { 
        font-size: 1.1rem; 
        color: var(--text-light);
    }
    
    /* --- BOTONES MODERNOS --- */
    .cta-button { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white; 
        padding: 18px 32px; 
        font-size: 1.2rem; 
        font-weight: 600;
        border: none; 
        border-radius: var(--radius-lg); 
        cursor: pointer; 
        margin: 24px auto; 
        display: block; 
        transition: all var(--transition-normal);
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }
    
    .cta-button::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: var(--transition-normal);
    }
    
    .cta-button:hover { 
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .cta-button:hover::after {
        left: 100%;
    }
    
    .cta-button:active {
        transform: translateY(0);
    }
    
    /* --- FORMULARIOS MODERNOS --- */
    form { 
        max-width: 500px; 
        margin: 0 auto; 
        text-align: left; 
        background: var(--surface);
        padding: 32px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
    }
    
    label { 
        display: block; 
        margin-top: 20px; 
        margin-bottom: 8px;
        font-weight: 600; 
        color: var(--text);
    }
    
    input[type="email"], 
    input[type="password"], 
    input[type="tel"], 
    input[type="text"], 
    textarea, 
    select { 
        width: 100%; 
        padding: 16px; 
        margin-top: 4px; 
        border: 2px solid var(--border); 
        border-radius: var(--radius-md); 
        font-size: 1rem;
        transition: var(--transition-fast);
        background: var(--background);
    }
    
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(139, 30, 63, 0.1);
    }
    
    .password-container { 
        position: relative; 
    }
    
    .password-container input { 
        padding-right: 50px; 
        width: 100%; 
        box-sizing: border-box; 
    }
    
    .password-container i { 
        position: absolute; 
        right: 16px; 
        top: 50%; 
        transform: translateY(-50%); 
        cursor: pointer; 
        color: var(--text-light);
        background: var(--background);
        padding: 8px;
        border-radius: var(--radius-sm);
        transition: var(--transition-fast);
    }
    
    .password-container i:hover {
        color: var(--primary);
        background: var(--surface);
    }
    
    button[type="submit"] { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white; 
        padding: 16px; 
        width: 100%; 
        border: none; 
        border-radius: var(--radius-md); 
        margin-top: 24px; 
        cursor: pointer; 
        font-size: 1.1rem;
        font-weight: 600;
        transition: var(--transition-normal);
        box-shadow: var(--shadow-sm);
    }
    
    button[type="submit"]:hover { 
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    /* --- MENSAJES DE ERROR Y ÉXITO --- */
    #error-message, #login-error, #success-message, #admin-login-error {
        display: none;
        margin-top: 16px;
        padding: 12px;
        border-radius: var(--radius-md);
        border-left: 4px solid var(--error);
        background: rgba(231, 76, 60, 0.1);
        color: var(--error);
    }
    
    #success-message {
        border-left: 4px solid var(--success);
        background: rgba(39, 174, 96, 0.1);
        color: var(--success);
    }
    
    #error-message:not(:empty),
    #login-error:not(:empty),
    #success-message:not(:empty),
    #admin-login-error:not(:empty) {
        display: block;
    }
    
    /* --- FOOTER MODERNO --- */
    footer { 
        display: flex; 
        justify-content: space-around; 
        align-items: center; 
        padding: 16px; 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white; 
        position: fixed; 
        width: 100%; 
        bottom: 0; 
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); 
        z-index: 1000;
        height: 60px;
        backdrop-filter: blur(10px);
    }
    
    footer .icon { 
        cursor: pointer; 
        font-size: 1.8rem; 
        margin: 0 15px; 
        transition: all var(--transition-normal);
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.1);
    }
    
    footer .icon:hover { 
        color: var(--accent); 
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    footer span:not(.icon) {
        font-size: 0.9rem;
        opacity: 0.8;
        font-weight: 500;
    }
    
    /* --- CONTEXT MENU --- */
    #context-menu { 
        position: fixed; 
        bottom: -60%; 
        left: 0; 
        width: 100%; 
        height: 60%; 
        background: var(--surface); 
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.2); 
        transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        z-index: 2000; 
        padding: 24px; 
        overflow-y: auto; 
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    
    #context-menu.active { 
        bottom: 0; 
    }
    
    #context-menu .close { 
        position: absolute; 
        top: 20px; 
        right: 20px; 
        font-size: 1.8rem; 
        cursor: pointer; 
        color: var(--text-light);
        transition: var(--transition-fast);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    #context-menu .close:hover {
        background: var(--background);
        color: var(--primary);
    }
    
    #context-menu ul { 
        list-style: none; 
    }
    
    #context-menu li { 
        margin: 12px 0; 
    }
    
    #context-menu a { 
        text-decoration: none; 
        color: var(--text); 
        font-size: 1.1rem; 
        display: block; 
        padding: 16px; 
        border-radius: var(--radius-md); 
        transition: var(--transition-fast); 
        font-weight: 500;
    }
    
    #context-menu a:hover { 
        background: var(--background); 
        transform: translateX(4px);
    }
    
    /* --- MEDIA QUERIES --- */
    @media (max-width: 768px) {
        #menu { 
            width: 85%; 
            right: -85%; 
        }
        #context-menu { 
            height: 70%; 
            bottom: -70%; 
        }
        .page h1 {
            font-size: 1.8rem;
        }
        form {
            padding: 24px;
        }
    }
    
    @media (min-width: 1024px) { 
        main { 
            max-width: 900px; 
            margin: 0 auto; 
        } 
    }
    
    /* --- COMPONENTES ESPECÍFICOS (Manteniendo consistencia) --- */
    .table-wrapper { 
        margin-bottom: 40px; 
        overflow-x: auto;
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 24px;
    }
    
    table { 
        width: 100%; 
        border-collapse: collapse; 
        background-color: var(--surface); 
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    
    th, td { 
        padding: 16px; 
        text-align: left; 
        border-bottom: 1px solid var(--border); 
    }
    
    th { 
        background-color: var(--primary); 
        color: white; 
        font-weight: 600;
        position: relative;
        cursor: pointer;
        user-select: none;
        transition: var(--transition-fast);
    }
    
    th:hover {
        background-color: var(--primary-dark);
    }
    
    th.sort-asc::after {
        content: ' ↑';
        opacity: 0.8;
    }
    
    th.sort-desc::after {
        content: ' ↓';
        opacity: 0.8;
    }
    
    tr:hover { 
        background-color: rgba(139, 30, 63, 0.05); 
    }
    
    .delete-all-btn { 
        background: linear-gradient(135deg, var(--error) 0%, #C0392B 100%);
        color: white; 
        padding: 12px 24px; 
        border: none; 
        border-radius: var(--radius-md); 
        cursor: pointer; 
        margin-bottom: 24px; 
        font-weight: 600;
        transition: var(--transition-normal);
        box-shadow: var(--shadow-sm);
    }
    
    .delete-all-btn:hover { 
        background: linear-gradient(135deg, #C0392B 0%, #A93226 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .logout-btn { 
        background: linear-gradient(135deg, var(--secondary) 0%, #1E8449 100%);
        color: white; 
        padding: 12px 24px; 
        border: none; 
        border-radius: var(--radius-md); 
        cursor: pointer; 
        margin-top: 20px; 
        font-weight: 600;
        transition: var(--transition-normal);
        box-shadow: var(--shadow-sm);
    }
    
    .logout-btn:hover { 
        background: linear-gradient(135deg, #1E8449 0%, #145A32 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .hero-section { 
        background: linear-gradient(135deg, var(--surface) 0%, #FEFEFE 100%);
        padding: 32px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        margin-bottom: 40px;
        border: 1px solid var(--border);
    }
    
    .steps-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
        gap: 24px; 
        margin: 32px 0; 
        text-align: center; 
    }
    
    .step-card { 
        background: var(--surface); 
        padding: 24px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        border-top: 6px solid var(--primary);
        transition: var(--transition-normal);
        position: relative;
        overflow: hidden;
    }
    
    .step-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }
    
    .step-card:hover { 
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }
    
    .step-card i { 
        font-size: 2.5rem; 
        color: var(--primary); 
        margin-bottom: 16px; 
        display: block; 
    }
    
    .step-card strong { 
        display: block; 
        margin-bottom: 8px; 
        font-size: 1.2rem; 
        color: var(--text);
    }
    
    .action-btn { 
        background: none; 
        border: none; 
        cursor: pointer; 
        font-size: 1.2rem; 
        margin-right: 10px; 
        color: var(--primary); 
        transition: var(--transition-fast);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-btn:hover { 
        color: var(--primary-dark); 
        background: var(--background);
    }
    
    .establecimientos-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        gap: 24px; 
    }
    
    .est-card { 
        background: var(--surface); 
        border-radius: var(--radius-lg); 
        overflow: hidden; 
        box-shadow: var(--shadow-md); 
        transition: all var(--transition-normal); 
        display: flex; 
        flex-direction: column;
        border: 1px solid var(--border);
    }
    
    .est-card:hover { 
        transform: translateY(-6px); 
        box-shadow: var(--shadow-lg);
    }
    
    .est-header { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white; 
        padding: 20px; 
        position: relative; 
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .est-type-badge { 
        position: absolute; 
        top: 16px; 
        right: 16px; 
        background-color: var(--accent); 
        color: var(--primary-dark); 
        padding: 6px 16px; 
        border-radius: 20px; 
        font-size: 0.8rem; 
        font-weight: bold; 
        text-transform: uppercase; 
        box-shadow: var(--shadow-sm);
    }
    
    .est-body { 
        padding: 20px; 
        flex: 1; 
        text-align: left; 
    }
    
    .est-body h3 { 
        margin-bottom: 12px; 
        font-size: 1.3rem; 
        color: var(--text); 
        font-weight: 700;
    }
    
    .est-body p { 
        font-size: 0.95rem; 
        color: var(--text-light); 
        margin-bottom: 10px; 
        margin-left: 0; 
    }
    
    .est-body i { 
        width: 20px; 
        color: var(--primary); 
        text-align: center; 
        margin-right: 8px; 
    }
    
    .est-footer { 
        padding: 16px 20px; 
        background-color: var(--background); 
        border-top: 1px solid var(--border); 
        font-size: 0.85rem; 
        color: var(--text-light); 
        text-align: right; 
    }
    
    .mi-establecimiento-form { 
        background: var(--surface); 
        padding: 32px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        max-width: 500px; 
        margin: 0 auto; 
        border: 1px solid var(--border);
    }
    
    .mi-establecimiento-form h2 { 
        margin-bottom: 24px; 
        color: var(--primary); 
    }
    
    /* Panel de control de establecimiento */
    .est-panel { 
        background: var(--surface); 
        padding: 32px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        max-width: 800px; 
        margin: 0 auto; 
        border: 1px solid var(--border);
    }
    
    .est-controls { 
        display: flex; 
        justify-content: center; 
        gap: 20px; 
        margin-top: 24px; 
        flex-wrap: wrap; 
    }
    
    .scan-btn { 
        background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
        color: white; 
        padding: 16px 32px; 
        border: none; 
        border-radius: var(--radius-md); 
        cursor: pointer; 
        font-size: 1.1rem; 
        font-weight: 600;
        box-shadow: var(--shadow-md); 
        transition: var(--transition-normal);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .scan-btn:hover { 
        background: linear-gradient(135deg, #2980b9 0%, #1F618D 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .est-stats { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        gap: 20px; 
        margin: 32px 0; 
    }
    
    .stat-card { 
        background: linear-gradient(135deg, var(--surface) 0%, #F9F9F9 100%);
        padding: 24px; 
        border-radius: var(--radius-lg); 
        text-align: center; 
        border: 1px solid var(--border);
        transition: var(--transition-normal);
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .stat-value { 
        font-size: 2.5rem; 
        font-weight: bold; 
        color: var(--primary); 
        margin-bottom: 8px;
    }
    
    .stat-label { 
        font-size: 1rem; 
        color: var(--text-light); 
    }
    
    .sellos-received-list { 
        max-height: 300px; 
        overflow-y: auto; 
        margin-top: 20px; 
        background: var(--background);
        border-radius: var(--radius-md);
        padding: 16px;
        border: 1px solid var(--border);
    }
    
    .premio-section { 
        background: linear-gradient(135deg, #d4edda 0%, #C8E6C9 100%);
        color: #155724; 
        padding: 24px; 
        border-radius: var(--radius-lg); 
        margin: 24px auto; 
        max-width: 600px; 
        border-left: 6px solid var(--success);
    }
    
    .admin-login-form { 
        background: var(--surface); 
        padding: 32px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        max-width: 400px; 
        margin: 0 auto; 
        border: 1px solid var(--border);
    }
    
    .admin-login-form h2 { 
        margin-bottom: 24px; 
        color: var(--primary); 
    }
    
    #search-container { 
        position: sticky; 
        bottom: 70px; 
        background: var(--surface); 
        padding: 16px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        z-index: 100; 
        margin-top: 24px; 
        display: flex; 
        align-items: center; 
        border: 1px solid var(--border);
    }
    
    #search-input { 
        width: 100%; 
        padding: 16px; 
        border: 2px solid var(--border); 
        border-radius: var(--radius-md); 
        font-size: 1rem; 
        margin-right: 12px; 
        transition: var(--transition-fast);
    }
    
    #search-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(139, 30, 63, 0.1);
        outline: none;
    }
    
    #search-icon { 
        color: var(--primary); 
        font-size: 1.3rem; 
        cursor: pointer;
        padding: 12px;
        border-radius: var(--radius-md);
        transition: var(--transition-fast);
    }
    
    #search-icon:hover {
        background: var(--background);
    }
    
    .stats-overview { 
        background: var(--surface); 
        padding: 32px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        max-width: 800px; 
        margin: 0 auto; 
        border: 1px solid var(--border);
    }
    
    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 24px; 
        margin-top: 24px; 
    }
    
    .stat-item { 
        background: linear-gradient(135deg, var(--surface) 0%, #F9F9F9 100%);
        padding: 24px; 
        border-radius: var(--radius-lg); 
        text-align: center; 
        border: 1px solid var(--border);
        transition: var(--transition-normal);
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .stat-number { 
        font-size: 2.8rem; 
        font-weight: bold; 
        color: var(--primary); 
        margin-bottom: 8px;
    }
    
    .stat-title { 
        font-size: 1rem; 
        color: var(--text-light); 
        margin-top: 4px; 
    }
    
    .simulated-recaptcha { 
        margin: 20px 0; 
        padding: 16px; 
        background: var(--background); 
        border-radius: var(--radius-md); 
        display: flex; 
        align-items: center; 
        border: 1px solid var(--border);
    }
    
    .simulated-recaptcha input { 
        margin-right: 12px; 
        transform: scale(1.2);
    }
    
    .simulated-recaptcha label { 
        cursor: pointer; 
        color: var(--text);
        font-weight: 500;
    }
    
    /* --- ESTILOS DEL ESCÁNER (OVERLAY) --- */
    #scanner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 30, 30, 0.98) 100%);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 5000;
    }
    
    #camera-window {
        position: relative;
        width: calc(100vw - 40px);
        height: calc(100vw - 40px);
        max-width: 400px;
        max-height: 400px;
        background-color: #000;
        overflow: hidden;
        border-radius: var(--radius-lg);
        border: 3px solid rgba(255, 255, 255, 0.2);
        transition: all var(--transition-normal);
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
    }
    
    #camera-window.detected {
        border: 4px solid var(--scanner-accent-green) !important;
        box-shadow: 0 0 30px rgba(46, 204, 113, 0.4);
    }
    
    #camera-window canvas {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    #qr-result-label {
        color: white;
        margin-top: 24px;
        font-size: 1.1rem;
        min-height: 1.5em;
        padding: 0 20px;
        word-break: break-all;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 12px 20px;
        border-radius: var(--radius-md);
        backdrop-filter: blur(10px);
    }
    
    /* Botón Redondo Sellar en medio de la cámara */
    #btn-sellar-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--scanner-success-color) 0%, #219653 100%);
        color: white;
        border: 4px solid white;
        font-weight: bold;
        font-size: 1.1rem;
        cursor: pointer;
        display: none;
        box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        animation: popIn 0.3s ease-out;
        z-index: 10;
        text-align: center;
        line-height: 92px;
        transition: all var(--transition-normal);
    }
    
    #btn-sellar-overlay:hover {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 12px 35px rgba(39, 174, 96, 0.6);
    }
    
    @keyframes popIn {
        0% { transform: translate(-50%, -50%) scale(0); }
        80% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    /* Mensaje de éxito del escáner */
    #scanner-success-msg {
        display: none;
        color: white;
        background: linear-gradient(135deg, var(--scanner-success-color) 0%, #219653 100%);
        padding: 40px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        font-size: 1.3rem;
        font-weight: 600;
        max-width: 80%;
        text-align: center;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5001;
        animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    /* --- ESTILOS PARA LA NUEVA PÁGINA DE INICIO (LANDING PAGE) --- */
    #inicio .landing-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        text-align: center;
        padding: 5rem 1.5rem 4rem;
        position: relative;
        overflow: hidden;
        margin: -80px -20px 0 -20px;
        width: calc(100% + 40px);
    }
    
    #inicio .landing-header::before {
        content: '';
        position: absolute;
        inset: 0;
        background: url('https://images.unsplash.com/photo-1506377247377-2a5b3b417ebb?auto=format&fit=crop&q=80&w=2000') center/cover;
        opacity: 0.18;
        mix-blend-mode: overlay;
    }
    
    #inicio .landing-header h1 {
        font-size: clamp(2.6rem, 7vw, 4.8rem);
        font-weight: 800;
        margin-bottom: 0.8rem;
        text-shadow: 0 3px 12px rgba(0,0,0,0.4);
        color: white;
    }
    
    #inicio .subtitle {
        font-size: clamp(1.3rem, 4vw, 1.8rem);
        font-weight: 500;
        opacity: 0.95;
        max-width: 720px;
        margin: 0 auto 2rem;
        color: white;
    }
    
    #inicio .landing-description {
        max-width: 720px;
        margin: 0 auto 2.5rem;
        font-size: 1.15rem;
        opacity: 0.92;
        color: white;
    }
    
    #inicio .landing-section {
        padding: 4rem 1.5rem;
        max-width: 1100px;
        margin: 0 auto;
    }
    
    #inicio .landing-section h2 {
        color: var(--primary);
        font-size: clamp(2rem, 5vw, 2.8rem);
        text-align: center;
        margin-bottom: 2.5rem;
        position: relative;
    }
    
    #inicio .landing-section h2::after {
        content: '';
        width: 80px;
        height: 4px;
        background: var(--accent);
        position: absolute;
        bottom: -12px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 2px;
    }
    
    #inicio .steps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.8rem;
        margin-bottom: 3rem;
    }
    
    #inicio .step-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-top: 6px solid var(--primary);
    }
    
    #inicio .step-card:hover {
        transform: translateY(-10px);
        box-shadow: var(--shadow-lg);
    }
    
    #inicio .step-number {
        width: 60px;
        height: 60px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        font-weight: bold;
        margin: 0 auto 1.2rem;
    }
    
    #inicio .terms, #inicio .privacy {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        margin: 2rem auto;
        max-width: 900px;
    }
    
    #inicio .highlight {
        color: var(--primary);
        font-weight: 700;
        font-size: 1.2rem;
        margin: 2rem 0;
    }
    
    #inicio .cta-final {
        text-align: center;
        margin: 4rem 0 2rem;
    }
    
    #inicio .landing-section ul {
        padding-left: 1.6rem;
        margin: 1.2rem 0;
    }
    
    #inicio .landing-section li {
        margin-bottom: 0.5rem;
    }
    
    /* Botones específicos para la landing page */
    #inicio .landing-header .cta-button {
        background: linear-gradient(135deg, var(--accent) 0%, #d4af37 100%);
        color: var(--text);
        font-weight: 700;
        padding: 1.1rem 2.4rem;
        border-radius: var(--radius-lg);
        font-size: 1.2rem;
        transition: all 0.28s ease;
        box-shadow: 0 6px 20px rgba(200, 159, 58, 0.35);
        margin: 0.8rem;
        border: none;
        cursor: pointer;
        display: inline-block;
    }
    
    #inicio .landing-header .cta-button:hover {
        background: linear-gradient(135deg, #d4af37 0%, #c89f3a 100%);
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(200, 159, 58, 0.5);
    }
    
    #inicio .landing-section .cta-button {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white;
        padding: 1.2rem 2.8rem;
        font-size: 1.3rem;
        border-radius: var(--radius-lg);
        margin: 0.8rem;
    }
    
    #inicio .landing-section .cta-button:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    }
    
    @media (max-width: 768px) {
        #inicio .landing-header {
            padding: 4rem 1rem 3rem;
            margin: -80px -20px 0 -20px;
            width: calc(100% + 40px);
        }
        #inicio .landing-section {
            padding: 3rem 1rem;
        }
        #inicio .landing-header .cta-button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
    }
</style>
</head>
<body>
<header>
<div class="logo"><i class="fas fa-wine-bottle"></i> Pasaporte del Vino</div>
<div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
</div>
</header>
<div id="menu">
<div class="close">&times;</div>
<ul>
<li><a href="?page=registrar"><i class="fas fa-file-download"></i> Registrar pasaporte</a></li>
<li><a href="?page=mipasaporte"><i class="fas fa-passport"></i> Mi pasaporte</a></li>
<li><a href="?page=establecimientos"><i class="fas fa-store"></i> Establecimientos</a></li>
<li><a href="?page=miestablecimiento"><i class="fas fa-user-tie"></i> Mi Establecimiento</a></li>
<li><a href="?page=admin"><i class="fas fa-cogs"></i> Admin</a></li>
</ul>
</div>
<div id="overlay"></div>
<main>
<!-- NUEVA PÁGINA DE INICIO (Landing Page Integrada) -->
<section id="inicio" class="page">
    <div class="landing-header">
        <h1>Pasaporte del Vino</h1>
        <p class="subtitle">Un viaje con sentido por las Rutas del Vino de Valladolid</p>
        <p class="landing-description">
            Si te gusta el enoturismo, si eres un apasionado del vino y aún no conoces las experiencias turísticas de nuestras Rutas del Vino… 
            <strong>¡regístrate ahora y empieza a coleccionar sellos!</strong>
        </p>
        <button class="cta-button" onclick="navigateTo('registrar')">
            <i class="fas fa-passport"></i> Registra tu Pasaporte
        </button>
    </div>

    <section class="landing-section">
        <h2>¿Cómo funciona?</h2>
        <div class="steps-grid">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3>Regístrate o descárgate el pasaporte</h3>
                <p>Consigue tu pasaporte digital registrándote o descárgate la hoja de sellado en PDF.</p>
            </div>
            <div class="step-card">
                <div class="step-number">2</div>
                <h3>Visita y disfruta</h3>
                <p>Acude a los establecimientos de las Rutas del Vino. Consulta localización y horarios en el listado de colaboradores.</p>
            </div>
            <div class="step-card">
                <div class="step-number">3</div>
                <h3>Consigue sellos</h3>
                <p>Consigue al menos <strong>4 sellos diferentes</strong>. En la versión digital se registran automáticamente; en papel, sella en cada visita.</p>
            </div>
            <div class="step-card">
                <div class="step-number">4</div>
                <h3>¡Gana premios!</h3>
                <p>Recibe GRATIS un lote de productos "Alimentos de Valladolid" + participa en el sorteo de 4 experiencias TOP.</p>
            </div>
        </div>

        <div class="cta-final">
            <button class="cta-button" onclick="navigateTo('registrar')">
                <i class="fas fa-passport"></i> Registra tu Pasaporte ahora
            </button>
        </div>
    </section>

    <section class="landing-section">
        <div class="terms">
            <h2>Premios y sorteo</h2>
            <p>Por cada pasaporte con <strong>mínimo 4 sellos distintos</strong> recibido antes del <strong>30 de diciembre de 2025</strong>:</p>
            <ul>
                <li>Lote GRATIS de productos <strong>"Alimentos de Valladolid, a gusto de todos"</strong></li>
                <li>Descuentos en entradas a Centros Turísticos provinciales</li>
            </ul>
            <p class="highlight">
                Sorteo → 4 experiencias de enoturismo TOP para dos personas (sorteo en enero 2026)
            </p>
        </div>

        <div class="cta-final">
            <button class="cta-button" onclick="navigateTo('registrar')">
                <i class="fas fa-passport"></i> ¡Registra tu Pasaporte y empieza a ganar!
            </button>
        </div>

        <div class="terms">
            <h2>Términos y condiciones resumidos</h2>
            <ul>
                <li>Mayores de edad</li>
                <li>Mínimo 4 sellos de diferentes establecimientos/actividades</li>
                <li>Fecha límite recepción: 30 de diciembre de 2025</li>
                <li>Sorteo en enero 2026</li>
                <li>Verificación de sellos auténticos y no repetidos</li>
            </ul>
        </div>
    </section>
</section>

<!-- RESTA DE LAS PÁGINAS (sin cambios) -->
<section id="registrar" class="page">
<h1>Registrar pasaporte</h1>
<div id="registration-container">
<form id="register-form">
<label for="email">Email:</label>
<input type="email" id="email" required placeholder="ejemplo@email.com">
<label for="password">Contraseña:</label>
<div class="password-container">
<input type="password" id="password" required placeholder="Mínimo 6 caracteres">
<i class="fas fa-eye" id="toggle-password"></i>
</div>
<label for="confirm-password">Confirmar Contraseña:</label>
<div class="password-container">
<input type="password" id="confirm-password" required placeholder="Repite tu contraseña">
<i class="fas fa-eye" id="toggle-confirm-password"></i>
</div>
<label for="tlf">Teléfono (opcional):</label>
<input type="tel" id="tlf" placeholder="+34 600 000 000">
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-registrar" required>
<label for="recaptcha-registrar">No soy un robot</label>
</div>
<button type="submit">Crear Pasaporte</button>
</form>
</div>
<div id="error-message"></div>
<div id="success-message"></div>
<div id="qr-code"></div>
<div id="post-register-actions" style="display:none; margin-top: 20px;">
<button class="cta-button" onclick="navigateTo('mipasaporte')">Ir a Mi Pasaporte</button>
</div>
</section>
<section id="mipasaporte" class="page">
<h1>Mi pasaporte</h1>
<form id="login-form" style="display: block;">
<label for="login-email">Email:</label>
<input type="email" id="login-email" required placeholder="ejemplo@email.com">
<label for="login-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="login-password" required placeholder="Tu contraseña">
<i class="fas fa-eye" id="toggle-login-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-login" required>
<label for="recaptcha-login">No soy un robot</label>
</div>
<button type="submit">Iniciar Sesión</button>
</form>
<div id="login-error"></div>
<div id="pasaporte-info" style="display: none;">
<p id="pasaporte-email"></p>
<p id="pasaporte-fecha-expedicion"></p>
<p id="pasaporte-sellos"></p>
<div id="premio-section" style="display: none;"></div>
<div id="pasaporte-qr" style="display: flex; justify-content: center; margin-top: 20px;"></div>
<button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
</div>
</section>
<section id="establecimientos" class="page">
<h1>Nuestros Establecimientos</h1>
<div class="establecimientos-grid" id="establecimientos-list"></div>
<div id="search-container">
<input type="text" id="search-input" placeholder="Buscar establecimiento...">
<i class="fas fa-search" id="search-icon"></i>
</div>
</section>
<section id="miestablecimiento" class="page">
<h1>Mi Establecimiento</h1>
<div id="mi-establecimiento-form-container" class="mi-establecimiento-form">
<form id="mi-establecimiento-login-form">
<label for="mi-est-nombre">Nombre del Establecimiento:</label>
<input type="text" id="mi-est-nombre" required placeholder="Ej. Bodegas Familiares">
<label for="mi-est-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="mi-est-password" required placeholder="Contraseña del establecimiento">
<i class="fas fa-eye" id="toggle-mi-est-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-est-login" required>
<label for="recaptcha-est-login">No soy un robot</label>
</div>
<button type="submit">Iniciar Sesión</button>
</form>
</div>
<div id="mi-establecimiento-panel" style="display: none; margin-top: 30px;">
<div class="est-panel">
<div id="est-info">
<h2>Bienvenido, <span id="est-nombre-display"></span></h2>
<div class="est-controls">
    <button class="scan-btn" onclick="startScanningOverlay()"><i class="fas fa-qrcode"></i> Escanear QR</button>
    <button class="logout-btn" onclick="logoutEstablecimiento()" style="margin-top:0;">Cerrar Sesión</button>
</div>
<div class="est-stats">
<div class="stat-card">
<div class="stat-value" id="sellos-count">0</div>
<div class="stat-label">Sellos Recibidos</div>
</div>
<div class="stat-card">
<div class="stat-value" id="visitas-count">0</div>
<div class="stat-label">Visitantes Diferentes</div>
</div>
</div>
</div>
<h3>Sellos Recibidos Recientes</h3>
<div class="sellos-received-list" id="sellos-list"></div>
</div>
</div>
</section>
<section id="admin-login" class="page">
<h1>Acceso Administrador</h1>
<div class="admin-login-form">
<form id="admin-login-form">
<label for="admin-email">Email:</label>
<input type="email" id="admin-email" value="admin@admin.com" required>
<label for="admin-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="admin-password" value="admin" required>
<i class="fas fa-eye" id="toggle-admin-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-admin" required>
<label for="recaptcha-admin">No soy un robot</label>
</div>
<button type="submit">Acceder</button>
</form>
</div>
<div id="admin-login-error"></div>
</section>
<section id="admin" class="page">
<h1>Panel de Administración</h1>
<div class="table-wrapper">
<h2>Pasaportes</h2>
<button class="delete-all-btn" onclick="clearTable('Pasaporte')">Borrar todos los pasaportes</button>
<table id="pasaporte-table">
<thead>
<tr>
    <th onclick="sortTable('pasaporte-table', 0, 'text')">Acciones</th>
    <th onclick="sortTable('pasaporte-table', 1, 'number')">ID</th>
    <th onclick="sortTable('pasaporte-table', 2, 'text')">Email</th>
    <th onclick="sortTable('pasaporte-table', 3, 'number')">Sellos</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="table-wrapper">
<h2>Establecimientos</h2>
<button class="delete-all-btn" onclick="clearTable('Establecimiento')">Borrar todos los establecimientos</button>
<table id="establecimiento-table">
<thead>
<tr>
    <th onclick="sortTable('establecimiento-table', 0, 'text')">Acciones</th>
    <th onclick="sortTable('establecimiento-table', 1, 'number')">ID</th>
    <th onclick="sortTable('establecimiento-table', 2, 'text')">Nombre</th>
    <th onclick="sortTable('establecimiento-table', 3, 'text')">Tipo</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="table-wrapper">
<h2>Sellos</h2>
<button class="delete-all-btn" onclick="clearTable('Sello')">Borrar todos los sellos</button>
<table id="sello-table">
<thead>
<tr>
    <th onclick="sortTable('sello-table', 0, 'number')">ID</th>
    <th onclick="sortTable('sello-table', 1, 'number')">ID Pasaporte</th>
    <th onclick="sortTable('sello-table', 2, 'number')">ID Establecimiento</th>
    <th onclick="sortTable('sello-table', 3, 'date')">Fecha</th>
    <th onclick="sortTable('sello-table', 4, 'text')">Activo</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
<section id="estadisticas" class="page">
<h1>Estadísticas de la Aplicación</h1>
<div class="stats-overview">
<div class="stats-grid">
<div class="stat-item">
<div class="stat-number" id="total-pasaportes">0</div>
<div class="stat-title">Pasaportes Registrados</div>
</div>
<div class="stat-item">
<div class="stat-number" id="total-establecimientos">0</div>
<div class="stat-title">Establecimientos Adheridos</div>
</div>
<div class="stat-item">
<div class="stat-number" id="total-sellos">0</div>
<div class="stat-title">Sellos Emitidos</div>
</div>
<div class="stat-item">
<div class="stat-number" id="pasaportes-completos">0</div>
<div class="stat-title">Pasaportes Completos (4+ sellos)</div>
</div>
</div>
</div>
</section>
<section id="altaestablecimiento" class="page">
<h1>Alta de Establecimiento</h1>
<div class="mi-establecimiento-form">
<form id="alta-establecimiento-form">
<label for="alta-nombre">Nombre del Establecimiento:</label>
<input type="text" id="alta-nombre" required placeholder="Ej. Bodegas Familiares">
<label for="alta-tipo">Tipo:</label>
<select id="alta-tipo" required>
<option value="Bodega">Bodega</option>
<option value="Restaurante">Restaurante</option>
<option value="Museo">Museo</option>
<option value="Alojamiento">Alojamiento</option>
<option value="Vinoteca">Vinoteca</option>
</select>
<label for="alta-direccion">Dirección:</label>
<input type="text" id="alta-direccion" required placeholder="Calle, Localidad...">
<label for="alta-descripcion">Descripción Corta:</label>
<textarea id="alta-descripcion" rows="3" required placeholder="Breve descripción de la experiencia..."></textarea>
<label for="alta-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="alta-password" required>
<i class="fas fa-eye" id="toggle-alta-password"></i>
</div>
<label for="alta-confirm-password">Confirmar Contraseña:</label>
<div class="password-container">
<input type="password" id="alta-confirm-password" required>
<i class="fas fa-eye" id="toggle-alta-confirm-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-alta" required>
<label for="recaptcha-alta">No soy un robot</label>
</div>
<button type="submit">Registrar Establecimiento</button>
</form>
</div>
</section>
</main>

<div id="scanner-overlay">
    <h1 style="color: white; margin-bottom: 24px; font-size: 2rem;">Escanear QR</h1>
    <div id="camera-window">
        <canvas id="scanner-canvas"></canvas>
        <button id="btn-sellar-overlay" onclick="sellarDesdeScanner()">Sellar</button>
    </div>
    <div id="qr-result-label">Buscando código QR...</div>
    <button onclick="stopScanningOverlay()" style="margin-top: 24px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 12px 32px; border-radius: var(--radius-md); cursor:pointer; font-size: 1rem; font-weight: 600; backdrop-filter: blur(10px); transition: var(--transition-normal);">Cancelar</button>
</div>

<div id="scanner-success-msg">
    <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
    Su pasaporte ha sido sellado con éxito
</div>

<footer>
<span class="icon home" title="Inicio" onclick="navigateTo('inicio')"><i class="fas fa-house"></i></span>
<span>2026-v0.12.1</span>
<span class="icon options" title="Opciones" onclick="toggleContextMenu()"><i class="fas fa-ellipsis-v"></i></span>
</footer>
<div id="context-menu">
<div class="close" onclick="toggleContextMenu()">&times;</div>
<ul id="context-items"></ul>
</div>

<script>
// Variables globales para ordenación
let currentSort = {
    tableId: null,
    columnIndex: null,
    direction: 'asc',
    type: null
};

document.addEventListener('DOMContentLoaded', () => {
    // --- VARIABLES ESCÁNER ---
    const scannerVideo = document.createElement("video");
    const scannerCanvasElement = document.getElementById("scanner-canvas");
    const scannerCanvas = scannerCanvasElement.getContext("2d", { willReadFrequently: true });
    const scannerOverlay = document.getElementById("scanner-overlay");
    const cameraWindow = document.getElementById("camera-window");
    const resultLabel = document.getElementById("qr-result-label");
    const btnSellarOverlay = document.getElementById("btn-sellar-overlay");
    const scannerSuccessMsg = document.getElementById("scanner-success-msg");

    let scanning = false;
    let localStream = null;
    let currentQRData = null;

    // Hamburger moderno
    const hamburger = document.getElementById('hamburger');
    const menu = document.getElementById('menu');
    const closeMenuBtn = menu.querySelector('.close');
    const overlay = document.getElementById('overlay');
    const pages = document.querySelectorAll('.page');
    const contextMenu = document.getElementById('context-menu');
    const contextItems = document.getElementById('context-items');

    function toggleMenu() {
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    hamburger.addEventListener('click', toggleMenu);
    closeMenuBtn.addEventListener('click', toggleMenu);

    overlay.addEventListener('click', () => {
        if (contextMenu.classList.contains('active')) {
            toggleContextMenu();
        } else if (menu.classList.contains('active')) {
            toggleMenu();
        }
    });

    window.toggleContextMenu = function() {
        contextMenu.classList.toggle('active');
        overlay.classList.toggle('active');
        loadContextItems();
    };

    function loadContextItems() {
        contextItems.innerHTML = '';
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'inicio';
        let items = [];
        if (page === 'admin') {
            items = ['Estadísticas', 'Alta Establecimiento', 'Exportar DB', 'Importar DB', 'Borrar DB', 'Configuración', 'Ayuda'];
        } else {
            items = ['Configuración', 'Ayuda'];
        }
        items.forEach(item => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.textContent = item;
            a.href = '#';
            a.onclick = (e) => {
                e.preventDefault();
                if (item === 'Alta Establecimiento') {
                    navigateTo('altaestablecimiento');
                } else if (item === 'Exportar DB') {
                    exportDB();
                } else if (item === 'Importar DB') {
                    importDB();
                } else if (item === 'Estadísticas') {
                    navigateTo('estadisticas');
                } else if (item === 'Borrar DB') {
                    if (confirm("¿Está seguro de que desea resetear toda la base de datos?")) {
                        localStorage.clear();
                        initDB();
                        alert("Base de datos reseteada con éxito.");
                        location.reload();
                    }
                }
                toggleContextMenu();
            };
            li.appendChild(a);
            contextItems.appendChild(li);
        });
    }

    window.navigateTo = function(page) {
        history.pushState(null, '', `?page=${page}`);
        loadPage();
    };

    function loadPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'inicio';
        pages.forEach(p => p.classList.remove('active'));
        const activePage = document.getElementById(page);
        if (activePage) {
            activePage.classList.add('active');
        } else if (page === 'inicio') {
            document.getElementById('inicio').classList.add('active');
        }
        if (page === 'mipasaporte') loadPasaporteInfo();
        if (page === 'admin') {
            if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                loadAdminData();
            } else {
                navigateTo('admin-login');
            }
        }
        if (page === 'establecimientos') {
            renderEstablecimientos();
            document.getElementById('search-input').value = '';
        }
        if (page === 'registrar') {
            const form = document.getElementById('register-form');
            form.reset();
            form.style.display = 'block';
            document.getElementById('post-register-actions').style.display = 'none';
            document.getElementById('success-message').textContent = '';
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').textContent = '';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('qr-code').innerHTML = '';
        }
        if (page === 'miestablecimiento') {
            const idEst = localStorage.getItem('currentEstablecimientoId');
            const loginFormContainer = document.getElementById('mi-establecimiento-form-container');
            const panel = document.getElementById('mi-establecimiento-panel');
            
            if (idEst) {
                loginFormContainer.style.display = 'none';
                panel.style.display = 'block';
                loadEstablecimientoPanel();
            } else {
                loginFormContainer.style.display = 'block';
                document.getElementById('mi-establecimiento-login-form').reset();
                panel.style.display = 'none';
            }
        }
        if (page === 'estadisticas') loadEstadisticas();
    }

    window.addEventListener('popstate', loadPage);
    loadPage();

    menu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const href = new URL(link.href);
            navigateTo(href.searchParams.get('page'));
            toggleMenu();
        });
    });

    // Database functions (sin cambios)
    function initDB() {
        const tables = ['Pasaporte', 'Establecimiento', 'Sello'];
        tables.forEach(t => {
            if (!localStorage.getItem(t)) {
                localStorage.setItem(t, JSON.stringify([]));
            }
        });
        const ps = JSON.parse(localStorage.getItem('Pasaporte'));
        if (ps.length === 0) seedData();
    }

    function seedData() {
        let pasaportes = [];
        for(let i=1; i<=5; i++) {
            pasaportes.push({
                id_pasaporte: i,
                email: `p${i}@p.com`,
                password: '.',
                tlf: `60000000${i}`,
                fecha_expedicion: new Date().toISOString(),
                fecha_expiracion: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString(),
                activo: 1
            });
        }
        localStorage.setItem('Pasaporte', JSON.stringify(pasaportes));
        let establecimientos = [];
        const tipos = ["Bodega", "Restaurante", "Museo", "Alojamiento", "Vinoteca"];
        for(let i=1; i<=20; i++) {
            const tipo = tipos[(i-1) % tipos.length];
            const nombre = `Establecimiento${i}@e.com`;
            establecimientos.push({
                id_establecimiento: i,
                nombre,
                tipo,
                direccion: `Calle ${i}, Localidad`,
                descripcion: `Descripción del ${nombre}`,
                password: '.',
                email: `info@${nombre}.com`,
                fecha_alta: new Date(Date.now() - Math.floor(Math.random() * 1000000000)).toISOString()
            });
        }
        localStorage.setItem('Establecimiento', JSON.stringify(establecimientos));
        
        let sellos = [];
        for(let i=1; i<=3; i++) {
            sellos.push({
                id_sello: i,
                id_pasaporte: 1,
                id_establecimiento: i,
                fecha: new Date().toISOString(),
                activo: 1
            });
        }
        localStorage.setItem('Sello', JSON.stringify(sellos));
    }

    const getTable = (t) => JSON.parse(localStorage.getItem(t) || '[]');
    const saveTable = (t, d) => localStorage.setItem(t, JSON.stringify(d));

    window.db = {
        getTable,
        addPasaporte: (data) => {
            let ps = getTable('Pasaporte');
            const id = ps.length > 0 ? Math.max(...ps.map(p => p.id_pasaporte)) + 1 : 1;
            const n = { 
                id_pasaporte: id, 
                ...data, 
                fecha_expedicion: new Date().toISOString(),
                fecha_expiracion: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString(), 
                activo: 1 
            };
            ps.push(n); 
            saveTable('Pasaporte', ps); 
            return n;
        },
        getPasaporte: (id) => getTable('Pasaporte').find(p => p.id_pasaporte === id),
        getPasaporteByEmail: (e) => getTable('Pasaporte').find(p => p.email === e && p.activo === 1),
        getSellosByPasaporte: (id) => getTable('Sello').filter(s => s.id_pasaporte === id && s.activo === 1),
        addEstablecimiento: (data) => {
            let ests = getTable('Establecimiento');
            const id = ests.length > 0 ? Math.max(...ests.map(e => e.id_establecimiento)) + 1 : 1;
            const n = { 
                id_establecimiento: id, 
                ...data, 
                fecha_alta: new Date().toISOString() 
            };
            ests.push(n); 
            saveTable('Establecimiento', ests); 
            return n;
        },
        getEstablecimiento: (id) => getTable('Establecimiento').find(e => e.id_establecimiento === id),
        getEstablecimientoByNombre: (n) => getTable('Establecimiento').find(e => e.nombre === n),
        addSello: (data) => {
            let ss = getTable('Sello');
            const id = ss.length > 0 ? Math.max(...ss.map(s => s.id_sello)) + 1 : 1;
            const n = { 
                id_sello: id, 
                ...data, 
                fecha: new Date().toISOString(), 
                activo: 1 
            };
            ss.push(n); 
            saveTable('Sello', ss); 
            return n;
        },
        getSellosByEstablecimiento: (id) => getTable('Sello').filter(s => s.id_establecimiento === id && s.activo === 1),
        getSellosByPasaporteAndEstablecimiento: (pid, eid) => getTable('Sello').find(s => s.id_pasaporte === pid && s.id_establecimiento === eid && s.activo === 1)
    };

    initDB();

    // Registro de pasaporte
    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const err = document.getElementById('error-message');
        const succ = document.getElementById('success-message');
        const qrDiv = document.getElementById('qr-code');
        err.textContent = ''; 
        err.style.display = 'none';
        succ.textContent = ''; 
        succ.style.display = 'none';
        qrDiv.innerHTML = '';

        if (!document.getElementById('recaptcha-registrar').checked) {
            err.textContent = 'Completa la verificación.';
            err.style.display = 'block';
            return;
        }

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (password !== document.getElementById('confirm-password').value) {
            err.textContent = 'Las contraseñas no coinciden.';
            err.style.display = 'block';
            return;
        }
        if (db.getTable('Pasaporte').some(p => p.email === email && p.activo === 1)) {
            err.textContent = 'El email ya existe.';
            err.style.display = 'block';
            return;
        }

        const newP = db.addPasaporte({ 
            email, 
            password, 
            tlf: document.getElementById('tlf').value 
        });
        registerForm.style.display = 'none';
        succ.textContent = '¡Pasaporte creado con éxito!';
        succ.style.display = 'block';
        const qrUrl = `airooc41n.github.io/miapp?email=${encodeURIComponent(email)}&Id=${newP.id_pasaporte}`;
        new QRCode(qrDiv, { 
            text: qrUrl, 
            width: 300, 
            height: 300,
            colorDark: "#8B1E3F",
            colorLight: "#FFFFFF",
            correctLevel: QRCode.CorrectLevel.H
        });
        localStorage.setItem('currentPasaporteId', newP.id_pasaporte);
        document.getElementById('post-register-actions').style.display = 'block';
    });

    // Login pasaporte
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        loginError.style.display = 'none';

        if (!document.getElementById('recaptcha-login').checked) {
            loginError.textContent = 'Completa la verificación.';
            loginError.style.display = 'block';
            return;
        }

        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-password').value;
        const p = db.getPasaporteByEmail(email);
        if (!p || p.password !== pass) {
            loginError.textContent = 'Error de credenciales.';
            loginError.style.display = 'block';
            return;
        }
        localStorage.setItem('currentPasaporteId', p.id_pasaporte);
        loadPasaporteInfo();
    });

    function loadPasaporteInfo() {
        const id = parseInt(localStorage.getItem('currentPasaporteId'));
        const info = document.getElementById('pasaporte-info');
        const loginF = document.getElementById('login-form');
        const premioSection = document.getElementById('premio-section');

        if (!id) {
            loginF.style.display = 'block';
            info.style.display = 'none';
            return;
        }

        const p = db.getPasaporte(id);
        if (!p) {
            logout();
            return;
        }

        loginF.style.display = 'none';
        info.style.display = 'block';
        document.getElementById('pasaporte-email').textContent = `Email: ${p.email}`;
        document.getElementById('pasaporte-fecha-expedicion').textContent = `Expedido: ${new Date(p.fecha_expedicion).toLocaleDateString()}`;
        const sellos = db.getSellosByPasaporte(id);
        const sellosCount = sellos.length;
        document.getElementById('pasaporte-sellos').textContent = `Sellos: ${sellosCount}`;

        const estIds = [...new Set(sellos.map(s => s.id_establecimiento))];
        const estDistintos = estIds.length;
        if (estDistintos >= 4) {
            premioSection.style.display = 'block';
            premioSection.innerHTML = '<div class="premio-section"><h3>¡Enhorabuena! Has conseguido 4 sellos diferentes.</h3><p>Puedes reclamar tu premio de productos "Alimentos de Valladolid".</p></div>';
        } else {
            premioSection.style.display = 'none';
        }

        const qrCont = document.getElementById('pasaporte-qr');
        qrCont.innerHTML = '';
        const qrUrl = `airooc41n.github.io/miapp?email=${encodeURIComponent(p.email)}&Id=${p.id_pasaporte}`;
        new QRCode(qrCont, { 
            text: qrUrl, 
            width: 250, 
            height: 250,
            colorDark: "#8B1E3F",
            colorLight: "#FFFFFF",
            correctLevel: QRCode.CorrectLevel.H
        });
    }

    window.logout = () => {
        localStorage.removeItem('currentPasaporteId');
        loadPasaporteInfo();
    };

    window.verPasaporte = (id) => {
        localStorage.setItem('currentPasaporteId', id);
        navigateTo('mipasaporte');
    };

    // Establecimientos con buscador
    window.renderEstablecimientos = () => {
        const list = document.getElementById('establecimientos-list');
        list.innerHTML = '';
        let ests = db.getTable('Establecimiento');
        ests.sort((a, b) => new Date(b.fecha_alta) - new Date(a.fecha_alta));

        ests.forEach(est => {
            const card = document.createElement('div');
            card.className = 'est-card';
            let iconClass = 'fa-building';
            if(est.tipo === 'Bodega') iconClass = 'fa-wine-bottle';
            if(est.tipo === 'Restaurante') iconClass = 'fa-utensils';
            if(est.tipo === 'Museo') iconClass = 'fa-landmark';
            if(est.tipo === 'Alojamiento') iconClass = 'fa-bed';
            if(est.tipo === 'Vinoteca') iconClass = 'fa-glass-cheers';

            card.innerHTML = `
            <div class="est-header">
                <i class="fas ${iconClass}" style="font-size: 2.5em; opacity: 0.9;"></i>
                <span class="est-type-badge">${est.tipo}</span>
            </div>
            <div class="est-body">
                <h3>${est.nombre}</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${est.direccion}</p>
                <p>${est.descripcion}</p>
            </div>
            <div class="est-footer">
                Alta: ${new Date(est.fecha_alta).toLocaleDateString()}
            </div>
            `;
            card.dataset.nombre = est.nombre.toLowerCase();
            card.dataset.tipo = est.tipo.toLowerCase();
            card.dataset.direccion = est.direccion.toLowerCase();
            list.appendChild(card);
        });
    };

    window.filterEstablecimientos = () => {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const cards = document.querySelectorAll('.est-card');
        cards.forEach(card => {
            const nombre = card.dataset.nombre || '';
            const tipo = card.dataset.tipo || '';
            const direccion = card.dataset.direccion || '';
            const match = nombre.includes(query) || tipo.includes(query) || direccion.includes(query);
            card.style.display = match ? 'flex' : 'none';
        });
    };

    // Login establecimiento
    const miEstLoginForm = document.getElementById('mi-establecimiento-login-form');
    if (miEstLoginForm) {
        miEstLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!document.getElementById('recaptcha-est-login').checked) {
                alert('Completa la verificación.');
                return;
            }

            const nombre = document.getElementById('mi-est-nombre').value.trim();
            const password = document.getElementById('mi-est-password').value;
            const est = db.getEstablecimientoByNombre(nombre);
            if (!est || est.password !== password) {
                alert('Credenciales incorrectas.');
                return;
            }
            localStorage.setItem('currentEstablecimientoId', est.id_establecimiento);
            
            document.getElementById('mi-establecimiento-form-container').style.display = 'none';
            document.getElementById('mi-establecimiento-panel').style.display = 'block';
            loadEstablecimientoPanel();
        });
    }

    // --- FUNCIONALIDAD DE ORDENACIÓN DE TABLAS ---
    window.sortTable = function(tableId, columnIndex, type) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const headers = table.querySelectorAll('th');
        
        // Resetear indicadores de ordenación en todos los headers
        headers.forEach((header, idx) => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Determinar dirección de ordenación
        let direction = 'asc';
        if (currentSort.tableId === tableId && currentSort.columnIndex === columnIndex) {
            direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        }
        
        // Actualizar estado actual
        currentSort = {
            tableId,
            columnIndex,
            direction,
            type
        };
        
        // Añadir clase de ordenación al header actual
        headers[columnIndex].classList.add(`sort-${direction}`);
        
        // Ordenar filas
        rows.sort((a, b) => {
            const aCell = a.cells[columnIndex].textContent.trim();
            const bCell = b.cells[columnIndex].textContent.trim();
            
            let aValue, bValue;
            
            if (type === 'number') {
                aValue = parseFloat(aCell) || 0;
                bValue = parseFloat(bCell) || 0;
            } else if (type === 'date') {
                aValue = new Date(aCell).getTime() || 0;
                bValue = new Date(bCell).getTime() || 0;
            } else {
                aValue = aCell.toLowerCase();
                bValue = bCell.toLowerCase();
            }
            
            if (direction === 'asc') {
                return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
            } else {
                return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
            }
        });
        
        // Reinsertar filas ordenadas
        rows.forEach(row => tbody.appendChild(row));
    };

    // --- LÓGICA DE ESCANEO ---
    window.startScanningOverlay = function() {
        scannerOverlay.style.display = "flex";
        btnSellarOverlay.style.display = "none";
        cameraWindow.classList.remove("detected");
        resultLabel.innerText = "Buscando código QR...";
        scannerSuccessMsg.style.display = 'none';
        
        scanning = true;

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                localStream = stream;
                scannerVideo.srcObject = stream;
                scannerVideo.setAttribute("playsinline", true);
                scannerVideo.play();
                requestAnimationFrame(tickOverlay);
            })
            .catch(function(err) {
                console.error("Error al acceder a la cámara", err);
                alert("No se pudo acceder a la cámara. Asegúrate de estar en HTTPS y dar permisos.");
                stopScanningOverlay();
            });
    }

    function tickOverlay() {
        if (!scanning) return;

        if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
            scannerCanvasElement.height = scannerVideo.videoHeight;
            scannerCanvasElement.width = scannerVideo.videoWidth;
            
            scannerCanvas.drawImage(scannerVideo, 0, 0, scannerCanvasElement.width, scannerCanvasElement.height);
            
            var imageData = scannerCanvas.getImageData(0, 0, scannerCanvasElement.width, scannerCanvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                drawQuadOverlay(code.location.topLeftCorner, code.location.topRightCorner, code.location.bottomRightCorner, code.location.bottomLeftCorner, "#00FF00");

                if (!cameraWindow.classList.contains("detected")) {
                    cameraWindow.classList.add("detected");
                }
                
                resultLabel.innerText = "Detectado: " + code.data;
                currentQRData = code.data;

                if (btnSellarOverlay.style.display !== "block") {
                    btnSellarOverlay.style.display = "block";
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(200);
                    }
                }
            }
        }
        requestAnimationFrame(tickOverlay);
    }

    function drawLineOverlay(begin, end, color) {
        scannerCanvas.beginPath();
        scannerCanvas.moveTo(begin.x, begin.y);
        scannerCanvas.lineTo(end.x, end.y);
        scannerCanvas.lineWidth = 4;
        scannerCanvas.strokeStyle = color;
        scannerCanvas.stroke();
    }

    function drawQuadOverlay(tl, tr, br, bl, color) {
        drawLineOverlay(tl, tr, color);
        drawLineOverlay(tr, br, color);
        drawLineOverlay(br, bl, color);
        drawLineOverlay(bl, tl, color);
    }

    window.stopScanningOverlay = function() {
        scanning = false;
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        scannerOverlay.style.display = "none";
    }

    window.sellarDesdeScanner = function() {
        if (!currentQRData) return;

        const urlParams = new URLSearchParams(currentQRData);
        let idPasaporte = urlParams.get('Id');
        
        if (!idPasaporte && currentQRData.includes('Id=')) {
            const parts = currentQRData.split('Id=');
            if (parts.length > 1) {
                idPasaporte = parts[1].split('&')[0];
            }
        }

        if (!idPasaporte) {
            alert('QR no válido para esta aplicación.');
            return;
        }

        const currentEstId = parseInt(localStorage.getItem('currentEstablecimientoId'));
        if (!currentEstId) {
            alert('Error de sesión. Vuelva a loguearse.');
            stopScanningOverlay();
            return;
        }

        const pasaporte = db.getPasaporte(parseInt(idPasaporte));
        if (!pasaporte) {
            alert('El pasaporte escaneado no existe en la base de datos.');
            return;
        }

        if (db.getSellosByPasaporteAndEstablecimiento(parseInt(idPasaporte), currentEstId)) {
            alert('Este pasaporte ya tiene un sello de este establecimiento.');
            return;
        }

        db.addSello({
            id_pasaporte: parseInt(idPasaporte),
            id_establecimiento: currentEstId
        });

        scanning = false;
        if (localStream) localStream.getTracks().forEach(track => track.stop());
        scannerOverlay.style.display = "none";

        scannerSuccessMsg.style.display = 'block';
        
        setTimeout(() => {
            scannerSuccessMsg.style.display = 'none';
            loadEstablecimientoPanel();
        }, 2000);
    }

    // Panel de Establecimiento
    function loadEstablecimientoPanel() {
        const id = parseInt(localStorage.getItem('currentEstablecimientoId'));
        if (!id) {
            navigateTo('miestablecimiento');
            return;
        }

        const est = db.getEstablecimiento(id);
        if (!est) {
            alert('Establecimiento no encontrado.');
            logoutEstablecimiento();
            return;
        }

        document.getElementById('est-nombre-display').textContent = est.nombre;
        const sellos = db.getSellosByEstablecimiento(id);
        document.getElementById('sellos-count').textContent = sellos.length;
        const pasaportesUnicos = [...new Set(sellos.map(s => s.id_pasaporte))];
        document.getElementById('visitas-count').textContent = pasaportesUnicos.length;

        const list = document.getElementById('sellos-list');
        list.innerHTML = '';
        if (sellos.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No hay sellos recibidos aún.</p>';
            return;
        }

        sellos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        sellos.slice(0, 10).forEach(s => {
            const div = document.createElement('div');
            div.style.padding = '12px';
            div.style.borderBottom = '1px solid var(--border)';
            div.style.marginBottom = '8px';
            div.style.borderRadius = 'var(--radius-sm)';
            div.style.background = 'var(--background)';
            div.innerHTML = `
                <div><strong>ID Pasaporte:</strong> ${s.id_pasaporte}</div>
                <div><strong>Fecha:</strong> ${new Date(s.fecha).toLocaleString()}</div>
            `;
            list.appendChild(div);
        });
    }

    window.logoutEstablecimiento = () => {
        localStorage.removeItem('currentEstablecimientoId');
        navigateTo('miestablecimiento');
    };

    // Admin Login
    const adminLoginForm = document.getElementById('admin-login-form');
    if (adminLoginForm) {
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const adminLoginError = document.getElementById('admin-login-error');
            adminLoginError.textContent = '';
            adminLoginError.style.display = 'none';

            if (!document.getElementById('recaptcha-admin').checked) {
                adminLoginError.textContent = 'Completa la verificación.';
                adminLoginError.style.display = 'block';
                return;
            }

            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;
            if (email === 'admin@admin.com' && password === 'admin') {
                localStorage.setItem('isAdminLoggedIn', 'true');
                navigateTo('admin');
            } else {
                adminLoginError.textContent = 'Credenciales incorrectas.';
                adminLoginError.style.display = 'block';
            }
        });
    }

    // Admin Panel
    window.loadAdminData = () => {
        if (localStorage.getItem('isAdminLoggedIn') !== 'true') {
            navigateTo('admin-login');
            return;
        }

        // Cargar pasaportes
        const tbodyP = document.querySelector('#pasaporte-table tbody');
        tbodyP.innerHTML = '';
        db.getTable('Pasaporte').forEach(p => {
            const sellos = db.getSellosByPasaporte(p.id_pasaporte);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><button class="action-btn" onclick="verPasaporte(${p.id_pasaporte})" title="Ver Pasaporte"><i class="fas fa-eye"></i></button></td>
                <td>${p.id_pasaporte}</td>
                <td>${p.email}</td>
                <td>${sellos.length}</td>`;
            tbodyP.appendChild(tr);
        });

        // Cargar establecimientos
        const tbodyE = document.querySelector('#establecimiento-table tbody');
        tbodyE.innerHTML = '';
        db.getTable('Establecimiento').forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><button class="action-btn" onclick="verEstablecimiento(${e.id_establecimiento})" title="Loguearse como este establecimiento"><i class="fas fa-eye"></i></button></td>
                <td>${e.id_establecimiento}</td>
                <td>${e.nombre}</td>
                <td>${e.tipo}</td>`;
            tbodyE.appendChild(tr);
        });

        // Cargar sellos
        const tbodyS = document.querySelector('#sello-table tbody');
        tbodyS.innerHTML = '';
        db.getTable('Sello').forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${s.id_sello}</td>
                <td>${s.id_pasaporte}</td>
                <td>${s.id_establecimiento}</td>
                <td>${new Date(s.fecha).toLocaleString()}</td>
                <td>${s.activo ? 'Sí' : 'No'}</td>
            `;
            tbodyS.appendChild(tr);
        });
        
        // Resetear indicadores de ordenación
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        currentSort = {
            tableId: null,
            columnIndex: null,
            direction: 'asc',
            type: null
        };
    };

    window.verEstablecimiento = (id) => {
        if(confirm("Se iniciará sesión automáticamente en este establecimiento. ¿Continuar?")) {
            localStorage.setItem('currentEstablecimientoId', id);
            navigateTo('miestablecimiento');
        }
    };

    // Toggle de visibilidad de contraseñas
    document.querySelectorAll('.password-container i').forEach(icon => {
        icon.addEventListener('click', function() {
            const input = this.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    // Exportar DB (MODIFICADO para refrescar automáticamente)
    window.exportDB = () => {
        const data = {};
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
            data[key] = localStorage.getItem(key);
        });
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pasaporte_vino_db.json';
        a.click();
        URL.revokeObjectURL(url);
    };

    // Importar DB (MODIFICADO para refrescar automáticamente)
    window.importDB = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    const tables = ['Pasaporte', 'Establecimiento', 'Sello'];

                    tables.forEach(tableName => {
                        if(importedData[tableName]) {
                            const importedArr = JSON.parse(importedData[tableName]);
                            const currentArr = JSON.parse(localStorage.getItem(tableName) || '[]');
                            const idField = 'id_' + tableName.toLowerCase();

                            const mergeMap = new Map();

                            currentArr.forEach(item => {
                                mergeMap.set(item[idField], item);
                            });

                            importedArr.forEach(item => {
                                mergeMap.set(item[idField], item);
                            });

                            const finalArray = Array.from(mergeMap.values());
                            localStorage.setItem(tableName, JSON.stringify(finalArray));
                        }
                    });

                    Object.keys(importedData).forEach(key => {
                        if (!tables.includes(key) && 
                            key !== 'isAdminLoggedIn' && 
                            key !== 'currentPasaporteId' && 
                            key !== 'currentEstablecimientoId') {
                                localStorage.setItem(key, importedData[key]);
                        }
                    });

                    alert('Base de datos importada y fusionada correctamente.');
                    
                    // Refrescar automáticamente las tablas en la página de admin
                    if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                        loadAdminData();
                    }
                } catch (err) {
                    alert('Error al procesar el archivo: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    };

    window.clearTable = function(table) {
        if (confirm(`¿Estás seguro de borrar todos los datos de ${table}?`)) {
            localStorage.setItem(table, JSON.stringify([]));
            loadAdminData();
        }
    };

    // Estadísticas
    window.loadEstadisticas = () => {
        const pasaportes = db.getTable('Pasaporte');
        const establecimientos = db.getTable('Establecimiento');
        const sellos = db.getTable('Sello');

        document.getElementById('total-pasaportes').textContent = pasaportes.length;
        document.getElementById('total-establecimientos').textContent = establecimientos.length;
        document.getElementById('total-sellos').textContent = sellos.length;

        let completos = 0;
        pasaportes.forEach(p => {
            const sellosP = db.getSellosByPasaporte(p.id_pasaporte);
            const estIds = [...new Set(sellosP.map(s => s.id_establecimiento))];
            if (estIds.length >= 4) completos++;
        });
        document.getElementById('pasaportes-completos').textContent = completos;
    };

    // Alta Establecimiento
    const altaForm = document.getElementById('alta-establecimiento-form');
    if (altaForm) {
        altaForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!document.getElementById('recaptcha-alta').checked) {
                alert('Completa la verificación.');
                return;
            }

            const nombre = document.getElementById('alta-nombre').value;
            const tipo = document.getElementById('alta-tipo').value;
            const direccion = document.getElementById('alta-direccion').value;
            const descripcion = document.getElementById('alta-descripcion').value;
            const password = document.getElementById('alta-password').value;
            const confirmPassword = document.getElementById('alta-confirm-password').value;

            if (password !== confirmPassword) {
                alert('Las contraseñas no coinciden.');
                return;
            }

            db.addEstablecimiento({
                nombre,
                tipo,
                direccion,
                descripcion,
                password
            });
            alert('¡Establecimiento registrado exitosamente!');
            altaForm.reset();
        });
    }

    document.getElementById('search-input').addEventListener('input', filterEstablecimientos);
});
</script>
</body>
</html>
